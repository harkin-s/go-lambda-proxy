version: 2.1
orbs:
    aws-cli: circleci/aws-cli@1.0.0

workflows:
    compile-and-push:
        jobs:
            - build-docker
            - push-ecr:
                requires:
                    - build-docker
            # - aws-ecr/build-and-push-image:
            #     account-url: AWS_ECR_ACCOUNT_URL_ENV_VAR_NAME
            #     aws-access-key-id: AWS_ACCESS_KEY_ID
            #     aws-secret-access-key: AWS_SECRET_ACCESS_KEY
            #     context: AWS_CREDS
            #     create-repo: true
            #     dockerfile: Dockerfile
            #     attach-workspace: true
            #     region: AWS_DEFAULT_REGION
            #     repo: go-lambda-proxy
            #     tag: CIRCLE_JOB
            #     workspace-root: workspace
            #     requires:
            #         - build-source
            

jobs:
  build-docker:
    docker:
        - image: circleci/golang:1.14
    steps:
      - checkout
      - run: go mod download
      - run: CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o app src/*.go
      - run: docker build -t ${IMAGE}:$CIRCLE_JOB .
      - run: mkdir -p workspace
      - run: cp ${IMAGE}:$CIRCLE_JOB workspace/
      - run: ls workspace/
      - persist_to_workspace:
            root: workspace
            paths: 
                - app
  
  push-ecr:
    executor: aws-cli/default
    steps:
        - checkout
        - attach_workspace:
            at: /workspace
        - run: ls workspace

